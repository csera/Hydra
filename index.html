<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
       <link rel="stylesheet" href="codebase/webix.css" type="text/css" media="screen" charset="utf-8">

       <script src="codebase/webix.js" type="text/javascript" charset="utf-8"></script>
       <script src="codebase/jquery-2.1.4.min.js"></script>
       <script src="codebase/Three49custom.js"></script>
       <script src="codebase/GLmol.js"></script>
       <script src="codebase/gridupdater.js"></script>
       
       	<!-- You can get these files from https://github.com/webix-hub/components -->
	   <script type="text/javascript">
			webix.require.disabled = true;
			webix.codebase = "http://cdn.webix.io/components/nicedit/";
		</script>
		<script src="http://cdn.webix.io/components/nicedit/nicedit.js"></script>
		<script src="http://cdn.webix.io/components/nicedit/nicedit/nicEdit.js"></script>

	   <style type="text/css">
		/*all divs called "masterarea" will have this style*/
	   div#masterarea {
	   	position: absolute; top: 0; left: 0;
			overflow: auto;
	   }
		/*table{float:center; border-spacing:0; padding:3px; border:0px;	height:100%; width:100%;}
		td{height:100%}*/
	    </style>

       <title>Hydra Î±</title>
	</head>

   <body>
   	<div id="masterarea" style="background-color: white; width: 100%;
		height: 100%; margin:0px; padding:0px"></div>
		<div id="titlebar" style='display:none;'>
			<h3 style='text-align:center'>Hydra Alpha Build: Ligand Docking
			Visualization Tool</h2>
			</div>
		</div>
	   	<!-- div for single central 1x1 viewer -->
	   <div id="mastergrid" style="display:none; width:100%; height: 100%;
		border:0px; margin:0px; background-color: black; padding:0px">
		   <!-- http://webglmol.sourceforge.jp/glmol/viewer.html -->
			<table id="view_table" align="center" cellspacing="0" cellpadding="3"
					 border="0" width="100%" height="100%">
				<tr>
					<td>
						<iframe src="viewer.html" width="100%" height="100%"
					frameBorder="0" scrolling="no" id="viewer" style="padding:0px;
					overflow: hidden;overflow-x: hidden;overflow-y: hidden;">
					</iframe>
					</td>
				</tr>
			</table>
	   </div>
			
		<script type="text/javascript" src="codebase/GLmol.js")></script>
		<script type="text/javascript" charset="utf-8">
		
		//var glmol = new GLmol('glmol',true);	
		
		// script modified from http://www.amcharts.com/tutorials/loading-external-data/
		function loadCSV(file) {
			//webix.message(file);
			webix.message("loadCSV");
		    var request;
		    if (window.XMLHttpRequest) {
		        // IE7+, Firefox, Chrome, Opera, Safari
		        request = new XMLHttpRequest();
		    } else {
		        // code for IE6, IE5
		        request = new ActiveXObject('Microsoft.XMLHTTP');
		    }
		    // load
		    request.open('GET', file, false);
		    request.send(); //THIS LINE is throwing an error that causes thread termination
		    //parseCSV(request.responseText);
		    compound_data = request.responseText;
		    //compound_data = JSON.parse(request.responseText)
		}
		
		function parseCSV(data){
		    alert(data);
		}
		// end
		
		function load_fxn(){
			// loads uploaded.js to overwrite compound_data var with uploaded data
			delete compound_data;
			
			/*var files = $$("uploader_1").files.data.pull;
			webix.message(files);
			var fID = $$("uploader_1").files.getFirstId();
			webix.message(fID);
			var fObj = $$("uploader_1").files.getItem(fID).file;
			webix.message(fObj);*/
			
			loadCSV("uploads/uploaded.txt");
			//parseCSV(compound_data)
			webix.message('loading');
			// refreshes the compounds list id comp_table via .refresh()
			$$("comp_table").define("data",compound_data);
			$$("comp_table").refresh();
			// displays message noting data loaded
			//webix.message('Compound List has been updated with the latest data.');
			webix.message('New compounds have been loaded.');
		}
		
		function clear_fxn(){
			// TEMP: WILL TURN INTO A FXN THAT CALLS .py SCRIPT TO WIPE uploaded.txt; then click refresh
			delete compound_data;
			loadCSV("uploads/blank.txt");
			//$$("comp_table").define("data","[{id:'1',compname:'No data loaded.'}]")
			$$("comp_table").define("data",compound_data);
			$$("comp_table").refresh();
			// displays message noting data loaded
			//webix.message('Previous data has been deleted. Press Update to clear list.');
			webix.message('Previous data has been deleted.');
		}
		
		// DataCollection referring to the uploaded compounds
		//var data_col = new webix.DataCollection({ 
		//	data:""
		//});
		
		// Data Processor
		// 
		
		webix.ready(function(){
			//webix.ui.fullScreen(); //for fullscreen on mobile devices
			
        	hydraUI = webix.ui({
				container:"masterarea",
				type:"line",
				responsive:"true",
				
				 rows:[
					// first row is a title header for app, maybe put more stuff here later?
					{template:"html->titlebar", height:1 },
					
					// second row, main content of app goes here
					{cols:[{
						// left column has control panel, upload manager as accordioned components
						view:"scrollview",
						scroll:"y",
						type:"line",
						body:
						{multi:true, view:"accordion", type:"line", 
							rows:[
							
							{header:"Upload to Viewer", maxWidth:250, collapsed:false, body:
								{id:'upload_controller', view:'form', elements:[
									{ //column index to upload to
										view:'text', value:'1', label:'Column', name:'uploadCol',
									},
									{ //row index to upload to
										view:'text', value:'1', label:'Row', name:'uploadRow',
									}
								]}
							},
							
							// Upload compound list / DOCK data
							{header:"Import Compounds", maxWidth:250, autoheight:true, collapsed:false, body:
								{view:"form", rows:[
									{ //Uploader element
										view:"uploader",
										value:"Upload .mol2 Files",
										id:"uploader_1",
										link:"myfiles",
										multiple:true,
										autosend:true,
										upload:"parser.php"
									},
									{ //Linked list of files from "uploader_1"
										id:"myfiles", view:"list", type:"uploader", maxHeight:200,
										scroll:true, autoheight:true, borderless:true,
									},
									{
										//view:"toolbar",
										cols:[
											{
												view:"button",id:"load_click",value:"Update Data",type:"form",click:"load_fxn"
											},
											{
												view:"button",id:"clear_click",value:"Clear Data",type:"danger",click:"clear_fxn"
											}
										]
									}
								]}
							},
							
							// control panel: grid dimensions and assigning compound IDs to objects
							{header:"Control Panel", maxWidth:250, collapsed:false, body:
								{view:"form", id:"grid_dim", elements:[
									//{view:"text",value:"blarg",label:"test",name:"mg"},
									{
										view:"text",value:"1",label:"Columns:",name:"numCol",//specifies cols count
									},
									{
										view:"text",value:"1",label:"Rows:",name:"numRow",//specifies rows count
									},
									/*{	// NOTE: feature not yet implemented --> dropdown menu to select the ID for each of the viewers in the central grid, as defined in the grid_dim form above; via this drop down menu, we can set and specify the docking file and legand to be shown in each viewer
										view:"form", type:"space", rows:[
											{
												view:"text",label:"Dock File:", id:"dock11var",
											},
											{
												view:"text",label:"Ligand File", id:"lig11var", 
											},
									]},*/
									{
										view:"button",id:"update_grid",value:"Update Grid",inputWidth:"150",align:"center",
										on:{
											'onItemClick': updategridfxn
											//function(){alert( $$('grid_dim').getValues().numRow )} //debug
										}
									},
								]},
							},
								
						]},
					},
					
					// middle column contains central workspace with all of the visualization object
					{id:"workspace", view:"scrollview", container:"central_workspace",type:"line",
					scroll:"xy", //Enables horizontal (x) and vertical (y) scrolling
					
					//Framework for a resizable grid of GLmol instances
					//Viewers start at index of 0 with coordinates (x,y)
					//Eg "viewer1,0" is in the first row, second column from the left
					body:{id:"workLayout", rows:[{
						id:"workRow"+"1",cols:[{
							view:"iframe",
							id:"viewer"+"1"+","+"1",
							src:"viewer.html",
							minWidth:250,minHeight:250,
							on:{
								'onAfterLoad':function(){
									this.getWindow().setGridCoordinates('1,1');
								}
							}
						}]
					}]}
					},
					
					// right column has compounds list, details are accordioned components
					{view:"scrollview",scroll:"y",body:
					{
						multi:true, view:"accordion", type:"line", 
						rows:[
						
						// Compound list showing cat,name from uploaded file
						{header:"Compound List", height:300, collapsed:false, body:
							{
								id:"comp_table",
								view:"datatable",
								select:true, 
								columns:[
									{ id:"id", header:"ID", width:50}, 
									{ id:"category", header:"Category", width:85}, 
									{ id:"compname", header:"Compound Name", fillspace:1 },
								], 
								data:'',
								minWidth:250,
								
							on:{
								onBeforeLoad:function(){
									this.showOverlay("Loading...");
								},
								onAfterLoad:function(){
									this.hideOverlay();
								}
							},
								//datatype:"json",
								//url:'compounds.json'
							}
						},
						{view:"resizer"},
						// Details of selected compound not shown in list, such as scores
						{header:"Compound Details", collapsed:false, body:
							{view:"form", id:"comp_det", maxWidth:250, rows:[
								{ view:"text",name:"category",label:"Category" },
								{ view:"text",name:"compname",label:"Name" },
								{ view:"text",name:"pdb",label:"PDB #" },
								{ view:"text",name:"res",label:"Residues" },
							]}
						},
						
						//For debugging: Textarea to display contents of .mol2/.pdb files
						/*{header:"File Value", collapsed:false, body:
							{view:"textarea", id:"file_dump", maxWidth:300}
						},*/
						
					]},	
					},
						 
				]}
				]
        	});
        	
			// Loads client-side file into instance after complete upload to browser
			$$("uploader_1").attachEvent("onAfterFileAdd",function(data){
					var x = $$('upload_controller').getValues().uploadCol,
						y = $$('upload_controller').getValues().uploadRow;
					
					var fileData = data.file;
					var reader = new FileReader();
					
					reader.readAsText(fileData);
					
					reader.onload = function(e) {
						//webix.message(reader.result);
						$$('comp_table').add(reader.result); //add data to table
						//hydraUI.parse(fileData, 'csv'); //load data into table
						
						$$('viewer'+x+','+y).getWindow().loadFile(reader.result);
						
					};
					reader.onerror = function(e) {
						console.error("File could not be read. code: "+e.target.error.code);
						alert("error");
					};
					
					//var viewerTbl = $('view_table');
					/*var viewerTbl = document.getElementById('view_table');
					viewerTbl.rows*/
			});
			
			/*$$('viewer0,0').attachEvent("onAfterLoad",function(){
				$$('viewer0,0').getWindow().setGridCoordinates('0,0');
			});*/
			
        	// binds selected compound detail panel with selection in compounds list, default selection is first
        	$$('comp_det').bind($$('comp_table'));
        	$$("comp_table").select(1);
        	
        	//$$("uploader_1").attachEvent("onUploadComplete", function(){
			//        webix.message("Upload Complete!");
			//});
        	
        	// syncs the compound list table displayed with the uploaded data DataCollection
        	//$$('comp_table').data.sync($$('data_col'));
        	
			//logic.init(); //reference to logic section
      });
			
		//Resizes GUI dynamically with the window size
      webix.event(window,"resize", function(){hydraUI.adjust();});
      </script>
	</body>
</html>