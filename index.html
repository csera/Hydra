<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
       <link rel="stylesheet" href="codebase/webix.css" type="text/css" media="screen" charset="utf-8">

       <script src="codebase/webix.js" type="text/javascript" charset="utf-8"></script>
       <script src="codebase/jquery-2.1.4.min.js"></script>
       <script src="codebase/Three49custom.js"></script>
       <script src="codebase/GLmol.js"></script>
       <script src="codebase/gridupdater.js"></script>
       
       	<!-- You can get these files from https://github.com/webix-hub/components -->
	   <script type="text/javascript">
			webix.require.disabled = true;
			webix.codebase = "http://cdn.webix.io/components/nicedit/";
		</script>
		<script src="http://cdn.webix.io/components/nicedit/nicedit.js"></script>
		<script src="http://cdn.webix.io/components/nicedit/nicedit/nicEdit.js"></script>

	   <style type="text/css">
		/*all divs called "masterarea" will have this style*/
	   div#masterarea {
	   	position: absolute; top: 0; left: 0;
			overflow: auto;
	   }
		/*table{float:center; border-spacing:0; padding:3px; border:0px;	height:100%; width:100%;}
		td{height:100%}*/
	    </style>

       <title>Hydra Î±</title>
	</head>

   <body>
   	<div id="masterarea" style="background-color: white; width: 100%;
		height: 100%; margin:0px; padding:0px"></div>
		<div id="titlebar" style='display:none;'>
			<h3 style='text-align:center'>Hydra Alpha Build: Ligand Docking
			Visualization Tool</h2>
			</div>
		</div>
	   	<!-- div for single central 1x1 viewer -->
	   <div id="mastergrid" style="display:none; width:100%; height: 100%;
		border:0px; margin:0px; background-color: black; padding:0px">
		   <!-- http://webglmol.sourceforge.jp/glmol/viewer.html -->
			<table id="view_table" align="center" cellspacing="0" cellpadding="3"
					 border="0" width="100%" height="100%">
				<tr>
					<td>
						<iframe src="viewer.html" width="100%" height="100%"
					frameBorder="0" scrolling="no" id="viewer" style="padding:0px;
					overflow: hidden;overflow-x: hidden;overflow-y: hidden;">
					</iframe>
					</td>
				</tr>
			</table>
	   </div>
			
		<script type="text/javascript" src="codebase/GLmol.js")></script>
		<script type="text/javascript" charset="utf-8">
		
		//var glmol = new GLmol('glmol',true);	
		
		// script modified from http://www.amcharts.com/tutorials/loading-external-data/
		function loadCSV(file) {
			//webix.message(file);
			webix.message("loadCSV");
		    var request;
		    if (window.XMLHttpRequest) {
		        // IE7+, Firefox, Chrome, Opera, Safari
		        request = new XMLHttpRequest();
		    } else {
		        // code for IE6, IE5
		        request = new ActiveXObject('Microsoft.XMLHTTP');
		    }
		    // load
		    request.open('GET', file, false);
		    request.send(); //THIS LINE is throwing an error that causes thread termination
		    //parseCSV(request.responseText);
		    compound_data = request.responseText;
		    //compound_data = JSON.parse(request.responseText)
		}
		
		function parseCSV(data){
		    alert(data);
		}
		// end
		
		//Change this fxn to update what's displayed in the viewers and compound list coordinates
		function load_fxn(){
			// loads uploaded.js to overwrite compound_data var with uploaded data
			//delete compound_data;
					
			/*loadCSV("uploads/uploaded.txt");
			//parseCSV(compound_data)
			webix.message('loading');
			// refreshes the compounds list id comp_table via .refresh()
			$$("comp_table").define("data",compound_data);
			$$("comp_table").refresh();
			// displays message noting data loaded
			//webix.message('Compound List has been updated with the latest data.');
			webix.message('New compounds have been loaded.');*/
			var fID, fData, x, y, origX, origY;
			
			for(var index=0; index<$$('uploadTable').count(); index++){
				fID = $$('uploadTable').getIdByIndex(index);
				fData = $$('uploadTable').getItem(fID).fileData;
				x = $$('uploadTable').getItem(fID).col, y = $$('uploadTable').getItem(fID).row;
				origX=$$('uploadTable').getItem(fID).oCol, origY=$$('uploadTable').getItem(fID).oRow;
				
				console.log($$('uploadTable').getItem(fID).oCol+','+$$('uploadTable').getItem(fID).oRow);
				//Only attempt load if the coordinates are valid AND the coordinates have been changed
				if (validCoordinates(x,y) && (x!=origX || y!=origY)){
					 //$$('uploadTable').getItem(fID).changeCheck == 1){
					
					webix.message('refreshing viewer'+x+','+y);
					
					//Calls loading function for "viewer[x],[y]" defined in the iframe source html
					$$('viewer'+x+','+y).getWindow().loadFile(fData,false);
					
					//Clear old cell if the structure was loaded
					if (origX!=0 && origY!=0) {
						$$('viewer'+origX+','+origY).getWindow().loadFile('',true);
					}
					
					//$$('uploadTable').getItem(fID).changeCheck = 0;
					$$('uploadTable').getItem(fID).oCol = x;
					$$('uploadTable').getItem(fID).oRow = y;
					//console.log("viewer"+x+','+y+' to '+$$('uploadTable').getItem(fID).changeCheck);
					console.log($$('uploadTable').getItem(fID).oCol+','+$$('uploadTable').getItem(fID).oRow);
				}
				else if (x==origX || y==origY) {
					webix.message("Coordinates have not been changed for "+
									  $$('uploadTable').getItem(fID).fileName);
				}
				else{
					webix.message('NOT loading '+$$('uploadTable').getItem(fID).fileName+' to '+x+','+y);
				}
			}
		}
		
		function clear_fxn(){
			//$$(...).getSelectedId returns an array of selected items
			var IDs = $$('uploadTable').getSelectedId(true);
			var x, y;
			
			//Go through each selected item and remove from viewer if it is loaded
			for(var a=0; a<IDs.length; a++){
				x = $$('uploadTable').getItem(IDs[a]).col;
				y = $$('uploadTable').getItem(IDs[a]).row;
				
				if (validCoordinates(x,y))
					$$('viewer'+x+','+y).getWindow().loadFile('', true);
			}
			
			$$('uploadTable').remove($$('uploadTable').getSelectedId(true));
		}
		
		function validCoordinates(x, y) {
			var numCols = $$('grid_dim').getValues().numCol,
				numRows = $$('grid_dim').getValues().numRow;
				
			if (0<x && x<= numCols && 0<y && y<=numRows) {
				console.log('Valid Coordinates');
				return true;
			}
			else{
				console.log('Invalid coordinates');
				return false;
			}
		}
		
		webix.ready(function(){
			//webix.ui.fullScreen(); //for fullscreen on mobile devices
			
        	hydraUI = webix.ui({
				container:"masterarea",
				type:"line",
				responsive:"true",
				
				 rows:[
					// first row is a title header for app, maybe put more stuff here later?
					{template:"html->titlebar", height:1 },
					
					// second row, main content of app goes here
					{cols:[{
						// left column has control panel, upload manager as accordioned components
						view:"scrollview",
						scroll:"y",
						type:"line",
						body:
						{multi:true, view:"accordion", type:"line", 
							rows:[
							
							/*{header:"Upload to Viewer", maxWidth:250, collapsed:false, body:
								{id:'upload_controller', view:'form', elements:[
									{ //column index to upload to
										view:'text', value:'1', label:'Column', name:'uploadCol',
									},
									{ //row index to upload to
										view:'text', value:'1', label:'Row', name:'uploadRow',
									}
								]}
							},*/
							
							// Upload compound list / DOCK data
							{header:"Import Compounds", maxWidth:250, autoheight:true, collapsed:false, body:
								{rows:[ //removed view:'form' to make this take up the whole width
									{ //Uploader element
										id:"uploader_1", view:"uploader",
										value:"Upload Files",
										//link:"myfiles",
										multiple:true, autosend:false,
										//can't find a way to remove items from uploader so set multiple:false
										//upload:"parser.php"
									},
									/*{ //Linked list of files from "uploader_1"
										id:"myfiles", view:"list", type:"uploader", //maxHeight:200,
										scroll:true, autoheight:true, borderless:true,
									},*/
									{
										id:"uploadTable", view:"datatable",
										select:true, multiselect:true, //ctrl+click & shift+click work
										drag:true, //NEED TO MAKE THIS SYNC WITH COMPOUND LIST
										editable:true, editaction:"dblclick",
										maxHeight:350, leftSplit:2, //left 2 col's won't scroll horizontally
										columns:[
											{id:"col", header:"Col", width:40, editor:"text"},
											{id:"oCol", header:"origCol", hidden:true},
											{id:"row", header:"Row", width:45, editor:"text"},
											{id:"oRow", header:"origRow", hidden:true},
											{id:"fileName", header:"File Name", width:200},
											{id:"fileData", header:"Data", hidden:true},
											{id:"changeCheck", header:"changed",hidden:true},
										],
										//on:{'onAfterEditStop':checkCoordChange(state,editor,ignoreUpdate)}
									},
									{
										cols:[
											{
												view:"button",id:"load_click",value:"Update Data",type:"form",
												click:"load_fxn"
											},
											{
												view:"button",id:"clear_click",value:"Delete Data",type:"danger",
												click:"clear_fxn"
											}
										]
									}
								]}
							},
							{view:'resizer'},
							
							// control panel: grid dimensions and assigning compound IDs to objects
							{header:"Control Panel", maxWidth:250, collapsed:false, body:
								{view:"form", id:"grid_dim", elements:[
									//{view:"text",value:"blarg",label:"test",name:"mg"},
									{
										view:"text",value:"1",label:"Columns:",name:"numCol",//specifies cols count
									},
									{
										view:"text",value:"1",label:"Rows:",name:"numRow",//specifies rows count
									},
									/*{	// NOTE: feature not yet implemented --> dropdown menu to select the ID for each of the viewers in the central grid, as defined in the grid_dim form above; via this drop down menu, we can set and specify the docking file and legand to be shown in each viewer
										view:"form", type:"space", rows:[
											{
												view:"text",label:"Dock File:", id:"dock11var",
											},
											{
												view:"text",label:"Ligand File", id:"lig11var", 
											},
									]},*/
									{
										view:"button",id:"update_grid",value:"Update Grid",inputWidth:"150",align:"center",
										on:{
											'onItemClick': updategridfxn
											//function(){alert( $$('grid_dim').getValues().numRow )} //debug
										}
									},
								]},
							},
								
						]},
					},
					
					// middle column contains central workspace with all of the visualization object
					{id:"workspace", view:"scrollview", container:"central_workspace",type:"line",
					scroll:"xy", //Enables horizontal (x) and vertical (y) scrolling
					
					//Framework for a resizable grid of GLmol instances
					//Viewers start at index of 1 with coordinates (x,y)
					//Eg "viewer2,1" is in the first row, second column from the left
					body:{id:"workLayout", type:'head', borderless:true, rows:[{
						id:"workRow"+"1", type:'head', borderless:true, cols:[{
							view:"iframe",
							id:"viewer"+"1"+","+"1",
							src:"viewer.html",
							minWidth:250,minHeight:250,
							on:{
								'onAfterLoad':function(){
									this.getWindow().setGridCoordinates('1,1');
								}
							}
						}]
					}]}
					},
					
					// right column has compounds list, details are accordioned components
					{view:"scrollview",scroll:"y",body:
					{
						multi:true, view:"accordion", type:"line", 
						rows:[
						
						// Compound list showing cat,name from uploaded file
						{header:"Compound List", height:300, collapsed:false, body:
							{
								id:"comp_table",
								view:"datatable",
								select:true, 
								columns:[
									{ id:"id", header:"ID", width:50}, 
									{ id:"category", header:"Category", width:85}, 
									{ id:"compname", header:"Compound Name", fillspace:1 },
								], 
								data:'',
								minWidth:250,
								
							on:{
								onBeforeLoad:function(){
									this.showOverlay("Loading...");
								},
								onAfterLoad:function(){
									this.hideOverlay();
								}
							},
								//datatype:"json",
								//url:'compounds.json'
							}
						},
						{view:"resizer"},
						// Details of selected compound not shown in list, such as scores
						{header:"Compound Details", collapsed:false, body:
							{view:"form", id:"comp_det", maxWidth:250, rows:[
								{ view:"text",name:"category",label:"Category" },
								{ view:"text",name:"compname",label:"Name" },
								{ view:"text",name:"pdb",label:"PDB #" },
								{ view:"text",name:"res",label:"Residues" },
							]}
						},
						
						//For debugging: Textarea to display contents of files
						/*{header:"File Value", collapsed:false, body:
							{view:"textarea", id:"file_dump", maxWidth:300}
						},*/
						
					]},	
					},
						 
				]}
				]
        	});
        	
			
			//Takes data from file and puts it in the "uploadTable" datatable
			$$("uploader_1").attachEvent("onAfterFileAdd",function(){
				var numFiles = 1+$$('uploader_1').files.getIndexById($$('uploader_1').files.getLastId());
				console.log(numFiles);
				var reader = new FileReader();
				var fID;
				//var fID = $$("uploader_1").files.getFirstId();
				for(var a=0; a<numFiles; a++){
					fID = $$('uploader_1').files.getIdByIndex(a);
					
					fName = $$("uploader_1").files.getItem(fID).name;
					fData = $$("uploader_1").files.getItem(fID).file;
					
					reader.readAsText(fData);
					
					reader.onload = function(e) {
						$$('uploadTable').add({col:0, oCol:0, row:0, oRow:0,
													 fileName:fName, fileData:reader.result});
						//Add the parsed file data to 'uploadTable" w/ default coordinates 0,0
						//Added as a string rather than an actual file object
					};
					reader.onerror = function(e) {
						console.error("File could not be read. Code: "+e.target.error.code);
						alert("error");
					};
				}
			});
			
        	/*$$('uploadTable').attachEvent('onAfterEditStop',function(state,editor){
				console.log("edit event detected");
				
				if (state.old != state.value) {
					//Note: The below function name is misleading.
					//It returns the items by default, but passing in (true,false) -> just IDs
					var sel = this.getSelectedId(true);
					var item = this.getItem(sel);
					
					item.changeCheck = 1;
					this.updateItem(sel,item);
					console.log("changeCheck set to true");
				}
			});*/
		
			// binds selected compound detail panel with selection in compounds list, default selection is first
        	$$('comp_det').bind($$('comp_table'));
        	$$("comp_table").select(1);
        	
        	// syncs the compound list table displayed with the uploaded data DataCollection
        	//$$('comp_table').data.sync($$('data_col'));
        	
			//logic.init(); //reference to logic section
      });
		
		//Resizes GUI dynamically with the window size
      webix.event(window,"resize", function(){hydraUI.adjust();});
      </script>
	</body>
</html>