<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
       <link rel="stylesheet" href="codebase/webix.css" type="text/css" media="screen" charset="utf-8">

       <script src="codebase/webix.js" type="text/javascript" charset="utf-8"></script>
       <script src="codebase/jquery-2.1.4.min.js"></script>
       <!--<script src="codebase/Three49custom.js"></script>
       <script src="codebase/GLmol.js"></script>-->
       <script src="codebase/gridupdater.js"></script>
       
       	<!-- You can get these files from https://github.com/webix-hub/components -->
	   <script type="text/javascript">
			webix.require.disabled = true;
			webix.codebase = "http://cdn.webix.io/components/nicedit/";
		</script>
		<script src="http://cdn.webix.io/components/nicedit/nicedit.js"></script>
		<script src="http://cdn.webix.io/components/nicedit/nicedit/nicEdit.js"></script>

	   <style type="text/css">
		/*all divs called "masterarea" will have this style*/
	   div#masterarea {
	   	position: absolute; top: 0; left: 0;
			overflow: auto;
	   }
		.activeViewer{
			border-color: #69A5FA;
			border-style: solid;
			border-width: 10px;
		}
	   </style>

       <title>Hydra Î±</title>
	</head>

   <body>
   	<div id="masterarea" style="background-color: white; width: 100%;
		height: 100%; margin:0px; padding:0px"></div>
		<div id="titlebar" style='display:none;'>
			<h3 style='text-align:center'>Hydra Alpha Build: Ligand Docking
			Visualization Tool</h2>
			</div>
		</div>
	   	<!-- div for single central 1x1 viewer -->
	   <div id="mastergrid" style="display:none; width:100%; height: 100%;
		border:0px; margin:0px; background-color: black; padding:0px">
		   <!-- http://webglmol.sourceforge.jp/glmol/viewer.html -->
			<table id="view_table" align="center" cellspacing="0" cellpadding="3"
					 border="0" width="100%" height="100%">
				<tr>
					<td>
						<iframe src="3Dmol frame.html" width="100%" height="100%"
					frameBorder="0" scrolling="no" id="viewer" style="padding:0px;
					overflow: hidden;overflow-x: hidden;overflow-y: hidden;">
					</iframe>
					</td>
				</tr>
			</table>
	   </div>
			
		<!--<script type="text/javascript" src="codebase/GLmol.js")></script>-->
		<script src="webixUI.js" charset="utf-8"></script>
		
		<script type="text/javascript" charset="utf-8">
		//Called by iframe if it is clicked, passed coordinates & view settings
		function iframeClicked(activeCoord, viewSettings) {
			//webix.message('You clicked viewer'+coordinates);
			//console.log($$('viewer'+coordinates).getWindow().getViewMode());
			//because JS is stupid and can't work with multidimensional arrays
			var compDisplay = viewSettings[0];
			var surfDisplay = viewSettings[1];
			var surfOpacity = viewSettings[2];
			var showAlphaCs = viewSettings[3];
			
			//Removes colored border from previously active viewer (if any)
			var prevActive = $$('activeCoord').getValue();
			if (prevActive)
				webix.html.removeCss($$('viewer'+prevActive).$view, "activeViewer");
			//Adds colored border to currently active viewer
			webix.html.addCss($$('viewer'+activeCoord).$view, "activeViewer");
			
			$$('activeCoord').setValue(activeCoord);
			$$('structType').setValue('struct'+compDisplay[0]);
			$$('surfOpacity').setValue(surfOpacity[0]);
			$$('surfType').setValue(surfDisplay[0]);
				//Because this references the value of surfOpacity when changed, it must be set
				//only AFTER surfOpacity is set. Otherwise the default view:'slider' val
				//pollutes the whole process
		}
		
		function setStruct(coord, listObj, structIndex){
			var glviewer = $$('viewer'+coord).getWindow().glviewer;
			var itemID = listObj.getValue();
			var itemVal = listObj.getPopup().getList().getItem(itemID).value;
			//var styleType = itemVal.toLowerCase();
			
			//glviewer.setStyle({},{styleType});
			
			//Ugly method. Try getting the variable method to work later...
			if (itemVal == 'Cartoon')
				glviewer.setStyle({hetflag:false},{cartoon:{color: 'spectrum'}});
			else if (itemVal == 'Sphere')
				glviewer.setStyle({},{sphere:{}});
			else if (itemVal == 'Stick')
				glviewer.setStyle({},{stick:{}});
			else if (itemVal == 'Line')
				glviewer.setStyle({},{line:{}});
			else if (itemVal == 'Cross')
				glviewer.setStyle({},{cross:{linewidth:5}});
			
			//NEED TO ALTER THIS TO WORK WITH HETATOMS/LIGANDS
			
			glviewer.render();
			
			//Store new setting in iframe
			$$('viewer'+coord).getWindow().compDisplay[structIndex] = itemVal;
		}
		
		function setSurface(coord, listObj, surfIndex, opacSet){
			var iViewer = $$('viewer'+coord).getWindow();
			var glviewer = iViewer.glviewer;
			var itemID = listObj.getValue(); //ID of of the list item
			var itemVal = listObj.getPopup().getList().getItem(itemID).value;
				console.log(itemVal);
				//What the list item actually displays
				
			if (iViewer.surfaces[surfIndex] != null) {
				console.log('Removing surface');
				glviewer.removeSurface(iViewer.surfaces[surfIndex]),
				iViewer.lastsurfstyle = 1;
			}
			if (itemVal == 'Van der Waals') {
				console.log('Adding VdW surface')
				iViewer.surfaces[surfIndex] =
					glviewer.addSurface(iViewer.$3Dmol.SurfaceType.VDW, {opacity:opacSet},
					{hetflag:false,chain:'A'},{hetflag:false,chain:'A'});
			}
			else if (itemVal == 'Molecular') {
				console.log('Adding molecular surface')
				iViewer.surfaces[surfIndex] =
					glviewer.addSurface(iViewer.$3Dmol.SurfaceType.MS, {opacity:opacSet},
					{hetflag:false,chain:'A'},{hetflag:false,chain:'A'});
			}
			else if (itemVal == 'Solvent Accessible') {
				console.log('Adding SA surface')
				iViewer.surfaces[surfIndex] =
					glviewer.addSurface(iViewer.$3Dmol.SurfaceType.SAS, {opacity:opacSet},
					{hetflag:false,chain:'A'},{hetflag:false,chain:'A'});
			}
			else if (itemVal == 'Solvent Excluded') {
				console.log('Adding SE surface')
				iViewer.surfaces[surfIndex] =
					glviewer.addSurface(iViewer.$3Dmol.SurfaceType.SES, {opacity:opacSet},
					{hetflag:false,chain:'A'},{hetflag:false,chain:'A'});
			}
			
			iViewer.surfDisplay[surfIndex] = itemID;
			iViewer.surfOpacity[surfIndex] = opacSet*100; //surfOpacity stores values of the slider
		}
		
		// script modified from http://www.amcharts.com/tutorials/loading-external-data/
		function loadCSV(file) {
			//webix.message(file);
			webix.message("loadCSV");
		    var request;
		    if (window.XMLHttpRequest) {
		        // IE7+, Firefox, Chrome, Opera, Safari
		        request = new XMLHttpRequest();
		    } else {
		        // code for IE6, IE5
		        request = new ActiveXObject('Microsoft.XMLHTTP');
		    }
		    // load
		    request.open('GET', file, false);
		    request.send(); //THIS LINE is throwing an error that causes thread termination
		    //parseCSV(request.responseText);
		    compound_data = request.responseText;
		    //compound_data = JSON.parse(request.responseText)
		}
		
		function parseCSV(data){
		    alert(data);
		}
		// end
		
		// Allows access to database file
		function readTextFile(file){
			txt = "";
		    var rawFile = new XMLHttpRequest();
		    rawFile.open("GET", file, false);
		    rawFile.onreadystatechange = function ()
		    {
		        if(rawFile.readyState === 4)
		        {
		            if(rawFile.status === 200 || rawFile.status == 0)
		            {
		                var allText = rawFile.responseText;
		                txt += rawFile.responseText;
		            }
		        }
		    }
		    rawFile.send(null);
		    return txt;
		}

		// Gets information from database regarding input Zinc IDs
		function searchData(zincArr, searchableData){
			// validation = searchableData.indexOf("ZINC");
			vendorCollect = new Array();
			all = searchableData.split("\n")
			for (var i=0;i<zincArr.length;i++){
				for (var line in all){
					toFind = all[line].indexOf(zincArr[i])
					if (toFind != -1){
						allSplit = all[line].split("\t");
						json_var = {idNum: i, compound: allSplit[0], 
							comp_img: "http://zinc.docking.org/img/sub/"+allSplit[0]+".gif",
							vendor: allSplit[1], website: allSplit[3],  email: allSplit[4], phone: allSplit[5], 
							fax:allSplit[6], orderurl:allSplit[7]}
							vendorCollect.push(json_var)
					}
				}
			}
			return vendorCollect;
		}

		// Gets information for compound list and details

		function zincRequests(arr1, arr2, arr3){
			basicInfo = new Array();
			for(var i=0;i<arr1.length;i++){
				json_head = {compound: arr1[i], category: "ZN ligand", res: arr2[i], bond: arr3[i]}
				basicInfo.push(json_head)
				console.log(json_head)
			}
			return basicInfo
		};
		
		function compound_fxn(arr1, arr2, arr3){
			var smallDatabase = readTextFile("codebase/3_purch.xls"),
			compInfo = zincRequests(arr1, arr2, arr3),
			dummy_comp = searchData(arr1, smallDatabase);

			// loads uploaded.js to overwrite compound_data var with uploaded data
			//delete compound_data;
			// refreshes the compounds list id comp_table via .refresh()
			$$("comp_table").define("data",compInfo);
			$$("comp_table").refresh();
			$$("comp_det").define("data",compInfo);
			$$("comp_det").refresh();
			$$("vendors").define("data",dummy_comp);
			$$("vendors").refresh();
		}
		
		//Change this fxn to update what's displayed in the viewers and compound list coordinates
		function load_fxn(){
			// loads uploaded.js to overwrite compound_data var with uploaded data
			//delete compound_data;
					
			/*loadCSV("uploads/uploaded.txt");
			//parseCSV(compound_data)
			webix.message('loading');
			// refreshes the compounds list id comp_table via .refresh()
			$$("comp_table").define("data",compound_data);
			$$("comp_table").refresh();
			// displays message noting data loaded
			//webix.message('Compound List has been updated with the latest data.');
			webix.message('New compounds have been loaded.');*/
			var fID, fData, fType, x, y, origX, origY;
			
			for(var index=0; index<$$('uploadTable').count(); index++){
				fID = $$('uploadTable').getIdByIndex(index);
				fData = $$('uploadTable').getItem(fID).fileData;
				x = $$('uploadTable').getItem(fID).col, y = $$('uploadTable').getItem(fID).row;
				origX=$$('uploadTable').getItem(fID).oCol, origY=$$('uploadTable').getItem(fID).oRow;
				
				//Only attempt load if the coordinates are valid AND the coordinates have been changed
				if (validCoordinates(x,y) && (x!=origX || y!=origY)){
					webix.message('refreshing viewer'+x+','+y);
					var viewer = $$('viewer'+x+','+y).getWindow().glviewer;
					
					fType = getFileType(fID);
					console.log('Detected file type: '+fType);
					
					//Calls loading function for "viewer[x],[y]" defined in the iframe source html
					viewer.clear();
					$$('viewer'+x+','+y).getWindow().fileToViewer(fData,fType);
					
					//Clear old cell if the structure was loaded
					if (origX!=0 && origY!=0) {
						//$$('viewer'+origX+','+origY).getWindow().loadFile('',true);
						$$('viewer'+origX+','+origY).getWindow().glviewer.clear();
					}
					
					$$('uploadTable').getItem(fID).oCol = x;
					$$('uploadTable').getItem(fID).oRow = y;
					
					console.log('Sent to '+$$('uploadTable').getItem(fID).oCol+
									','+$$('uploadTable').getItem(fID).oRow);
				}
				else if (x==origX || y==origY) {
					webix.message("Coordinates have not been changed for "+
									  $$('uploadTable').getItem(fID).fileName);
				}
				else{
					webix.message('NOT loading '+$$('uploadTable').getItem(fID).fileName+' to '+x+','+y);
				}
			}
		}
		
		function getFileType(fID) {
			var fName = $$('uploadTable').getItem(fID).fileName;
			var fType;
			
			//Split fName into an array with elements demarcated by a '.'
			var splitName = fName.split('.');
			
			//User may have included '.' in the name so only grab the last one
			fType = splitName[splitName.length-1];
			
			return fType;
      }
		
		function clear_fxn(){
			//$$(...).getSelectedId returns an array of selected items (with param (true))
			var IDs = $$('uploadTable').getSelectedId(true);
			var x, y;
			
			//Go through each selected item and remove from viewer if it is loaded
			for(var a=0; a<IDs.length; a++){
				x = $$('uploadTable').getItem(IDs[a]).col;
				y = $$('uploadTable').getItem(IDs[a]).row;
				
				var fType = getFileType(IDs[a]);
				
				if (validCoordinates(x,y)){
					var viewer = $$('viewer'+x+','+y).getWindow().glviewer;
					//$$('viewer'+x+','+y).getWindow().$3Dmol.loadFile('',fType,viewer,{doAssembly:true});
					viewer.clear();
				}
			}
			
			$$('uploadTable').remove($$('uploadTable').getSelectedId(true));
		}
		
		function validCoordinates(x, y) {
			var numCols = $$('grid_dim').getValues().numCol,
				numRows = $$('grid_dim').getValues().numRow;
				
			if ((0<x && x<= numCols) && (0<y && y<=numRows)) {
				console.log('Valid Coordinates');
				return true;
			}
			else{
				console.error('Invalid coordinates');
				return false;
			}
		}
		
		
      </script>
	</body>
</html>